---
dist: xenial
language: perl
perl:
  - "5.24"
branches:
  only:
    - stable-2.0
    - master
addons:
  hosts:
    - testing.acme.com
  apt:
    packages:
      - codespell
      - librrds-perl
      - rrdtool
      - devscripts
      - libpango1.0-dev
      - python3-flake8
      - shellcheck
notifications:
  email: false
  irc:
    on_success: change  # no need for spam
    on_failure: always
    channels:
      - "irc.oftc.net#munin"
    template:
      - "%{repository} (%{branch} - %{commit} : %{author}): %{message}"
      - "Build details: %{build_url}"
matrix:
  # we don't need to continue any build when 1 test is failing.
  fast_finish: true

env:
  # specify test level and announce cpanm's installation directory
  - TEST_MEDIUM=1 PERLLIB=/home/travis/perl5/lib/perl5

before_install:
  - cpanm -n Devel::Cover::Report::Coveralls
  - cpanm --quiet --installdeps --notest .

install:
  - perl Build.PL
  - ./Build build
  # We want to lint first, to avoid expensive tests if code isn't clean
  # The "PYTHON_LINT_CALL" environment variable works around an old version of python3-flake8 that
  # is available in the travis environment.
  - PYTHON_LINT_CALL="python3 -m flake8.main" make lint
script:
  - cover -test -report coveralls
